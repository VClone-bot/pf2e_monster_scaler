<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>PF2e Creature Level Adjuster</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; margin: 20px; }
    .row { display: grid; gap: 12px; grid-template-columns: 1fr 1fr; }
    textarea { width: 100%; min-height: 220px; }
    pre { background: #f6f7f8; padding: 12px; overflow: auto; }
    input, select, button { padding: 8px; }
    label { font-weight: 600; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>
<body>
  <h1>PF2e Creature Level Adjuster</h1>

  <div class="row">
    <div>
      <label>Paste statblock text</label><br/>
      <textarea id="raw" placeholder="Paste AoN statblock text here"></textarea>
      <p><small>Tip: on Archives of Nethys, use the copy button on the statblock.</small></p>

      <label>Or upload an image (PNG/JPG) for OCR</label><br/>
      <input id="file" type="file" accept="image/*,.txt,.md,.json,.pdf" />
      <div id="busy" style="display:none">Processing…</div>
    </div>

    <div>
      <label>Target level</label><br/>
      <input id="lvl" type="number" value="12"/><br/><br/>

      <label>HP scaling (optional)</label><br/>
      <select id="hp">
        <option value="none">None (Quick Adjust rule)</option>
        <option value="linear-2-per-level">Linear: ~+10 HP per level</option>
        <option value="percent-10-per-step">Percent: ±10% per level</option>
      </select><br/><br/>

      <button id="run">Adjust</button>
      <button id="download" disabled>Download JSON</button>
    </div>
  </div>

  <h2>Adjusted output</h2>
  <pre id="out">Provide input, set a level, then click Adjust.</pre>

<script>
const clampNum = v => (Number.isFinite(+v) ? +v : undefined);

function parseStatblockText(text) {
  const get = re => { const m = text.match(re); return m ? clampNum(m[1]) : undefined; };
  const name = (text.match(/^([\p{L}\p{N}'()\[\]\-\s]+)\s*\n/i) || ["",""])[1].trim();
  const level = get(/Level\s*([\-]?\d+)/i) ?? get(/Creature\s*([\-]?\d+)/i) ?? 0;
  const ac = get(/AC\s*(\d{1,2})/i);
  const perception = get(/Perception\s*([+\-]?\d{1,2})/i);
  const saveFort = get(/Fortitude\s*([+\-]?\d{1,2})/i);
  const saveRef  = get(/Reflex\s*([+\-]?\d{1,2})/i);
  const saveWill = get(/Will\s*([+\-]?\d{1,2})/i);
  const attack = get(/Melee[\s\S]*?\+([\-]?\d{1,2})\s*to\s*hit/i) ?? get(/Strike[^\n]*?\+([\-]?\d{1,2})/i);
  const dc = get(/DC\s*(\d{1,2})/i);
  let damagePerStrike;
  const dmg = text.match(/(\d+)d(\d+)(?:\s*[+\-]\s*(\d+))?/i);
  if (dmg) { const dice=+dmg[1], faces=+dmg[2], bonus=dmg[3]?+dmg[3]:0; damagePerStrike = Math.round(dice*(faces+1)/2 + bonus); }
  const hp = get(/HP\s*(\d{1,3})/i);

  const skills = {};
  const skillsLine = text.match(/Skills?\s*([\s\S]*?)(?:\n|Str\s*[+\-])/i)?.[1];
  if (skillsLine) for (const m of skillsLine.matchAll(/([A-Za-z][A-Za-z ]+?)\s*([+\-]?\d{1,2})/g)) skills[m[1].trim()] = +m[2];

  return {
    name: name || "Creature", level: Number(level), ac, attack, perception,
    saveFort, saveRef, saveWill, dc, damagePerStrike, hp,
    skills: Object.keys(skills).length ? skills : undefined,
    notes: "Parsed from text. Review before scaling."
  };
}

function applyQuickAdjust(sb, targetLevel, opts) {
  const src = { ...sb };
  const delta = targetLevel - src.level;
  const step = Math.sign(delta);
  const steps = Math.abs(delta);

  const add = (x, inc=0) => (x==null ? undefined : x + inc);

  let { ac, attack, dc, saveFort, saveRef, saveWill, perception, skills,
        damagePerStrike: dmgStrike, damageLimited: dmgLimited, hp } = src;

  for (let i=0;i<steps;i++) {
    const inc = step*2;
    ac = add(ac, inc);
    attack = add(attack, inc);
    dc = add(dc, inc);
    saveFort = add(saveFort, inc);
    saveRef = add(saveRef, inc);
    saveWill = add(saveWill, inc);
    perception = add(perception, inc);
    if (skills) skills = Object.fromEntries(Object.entries(skills).map(([k,v]) => [k, v + inc]));
    dmgStrike = add(dmgStrike, step*2);
    dmgLimited = add(dmgLimited, step*4);
    if (opts.hpHeuristic === "linear-2-per-level") hp = add(hp, step*10);
    else if (opts.hpHeuristic === "percent-10-per-step" && hp!=null) hp = Math.max(1, Math.round(hp*(1+0.10*step)));
  }

  return { ...src, level: targetLevel, ac, attack, dc, saveFort, saveRef, saveWill,
           perception, skills, damagePerStrike: dmgStrike, damageLimited: dmgLimited, hp };
}

function downloadJSON(name, data) {
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href = url; a.download = name; a.click();
  URL.revokeObjectURL(url);
}

async function ocrFile(file) {
  const worker = await Tesseract.createWorker({ logger: ()=>{} });
  try {
    await worker.loadLanguage("eng");
    await worker.initialize("eng");
    const { data: { text } } = await worker.recognize(file);
    return text;
  } finally { await worker.terminate(); }
}

// Wire up UI
const $ = sel => document.querySelector(sel);
const raw = $("#raw"), out = $("#out");
$("#run").onclick = () => {
  const base = parseStatblockText(raw.value || "");
  const target = parseInt($("#lvl").value || "0", 10);
  const hpH = $("#hp").value;
  const adjusted = applyQuickAdjust(base, target, { hpHeuristic: hpH });
  out.textContent = JSON.stringify(adjusted, null, 2);
  $("#download").disabled = false;
  $("#download").onclick = () => downloadJSON(`${adjusted.name.replace(/\\s+/g,'_')}_L${adjusted.level}.json`, adjusted);
};

$("#file").onchange = async (e) => {
  const f = e.target.files?.[0]; if (!f) return;
  const ext = (f.name.split(".").pop() || "").toLowerCase();
  $("#busy").style.display = "block";
  try {
    if (["png","jpg","jpeg","webp","gif","bmp"].includes(ext)) {
      raw.value = await ocrFile(f);
    } else if (ext === "pdf") {
      alert("PDF text extraction is not built-in. Export the page as an image and upload it, or copy-paste text.");
    } else {
      raw.value = await f.text();
    }
  } finally { $("#busy").style.display = "none"; }
};
</script>
</body>
</html>
